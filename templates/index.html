<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Mission Control // IBM AggieSat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #020617; color: #f8fafc; margin: 0; overflow: hidden; }
        .header-font { font-family: 'Orbitron', sans-serif; }
        #map { height: 500px; width: 100%; border-radius: 1rem; border: 1px solid #1e293b; background: #0f172a; }
        .stat-card { background: rgba(15, 23, 42, 0.8); border: 1px solid #1e293b; padding: 1.5rem; border-radius: 1rem; }
        .marker-pin { width: 12px; height: 12px; border-radius: 50%; background: #ff4b2b; position: absolute; left: 50%; top: 50%; margin: -6px 0 0 -6px; z-index: 10; box-shadow: 0 0 15px #ff4b2b; }
        .pulse { background: rgba(255, 75, 43, 0.4); border-radius: 50%; height: 40px; width: 40px; position: absolute; left: 50%; top: 50%; margin: -20px 0 0 -20px; animation: pulsate 1.5s ease-out infinite; opacity: 0; z-index: 5; }
        @keyframes pulsate { 0% { transform: scale(0.1); opacity: 0.0; } 50% { opacity: 1.0; } 100% { transform: scale(1.5); opacity: 0.0; } }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-black header-font text-sky-400 uppercase tracking-wider">Mission Control</h1>
                <p id="location-text" class="text-slate-500 font-mono text-xs mt-1 uppercase tracking-[0.3em]">Establishing Downlink...</p>
            </div>
            <div class="bg-slate-900 border border-slate-800 px-5 py-2 rounded-full flex items-center gap-3">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <span id="status-text" class="text-[10px] font-bold header-font uppercase tracking-widest">Connected</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 relative">
                <div id="map"></div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="stat-card">
                    <p class="text-[10px] text-sky-500 font-bold uppercase tracking-widest mb-2">Altitude</p>
                    <div class="text-3xl font-bold header-font"><span id="alt-val">---</span> <span class="text-sm text-slate-500 font-normal">KM</span></div>
                </div>
                <div class="stat-card">
                    <p class="text-[10px] text-sky-500 font-bold uppercase tracking-widest mb-2">Coordinates</p>
                    <div id="coords-val" class="text-xl font-mono text-slate-300">0.00째N, 0.00째W</div>
                </div>
                <div class="stat-card">
                    <p class="text-[10px] text-sky-500 font-bold uppercase tracking-widest mb-2">Predictive Projection</p>
                    <input type="range" id="path-slider" min="0" max="5000" value="1000" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-sky-500">
                    <div class="flex justify-between mt-2 text-[10px] font-mono text-slate-500">
                        <span>NOW</span>
                        <span>+ <span id="miles-display">1000</span> MILES</span>
                    </div>
                </div>
                <div class="stat-card flex-grow flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] text-sky-500 font-bold uppercase tracking-widest mb-2">Telemetry Log</p>
                        <div id="log-text" class="text-xs font-mono text-slate-400 leading-relaxed italic">Awaiting handshake...</div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-800 text-[10px] text-slate-500 font-mono">
                        NODE: IBM-CE-PROD-TX
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize Map for EnduroSat One
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20, 0], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const satelliteIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='marker-pin'></div><div class='pulse'></div>",
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        const marker = L.marker([0, 0], { icon: satelliteIcon }).addTo(map);

        let currentPos = { lat: 0, lng: 0 };
        let velocity = { lat: 0, lng: 0 };
        let isInitialized = false;

        async function updateTelemetry() {
            try {
                const response = await fetch('/api/telemetry');
                const data = await response.json();

                if (data.lat !== undefined) {
                    // UI Updates
                    document.getElementById('alt-val').innerText = data.alt.toFixed(1);
                    document.getElementById('coords-val').innerText = `${data.lat.toFixed(4)}째N, ${data.lng.toFixed(4)}째W`;
                    document.getElementById('location-text').innerText = `NODE: ${data.name} // ${data.location}`;
                    
                    // Narrative Log update
                    document.getElementById('log-text').innerText = `Edge Node 43466 (EnduroSat) synchronized. Trajectory reconciliation complete.`;

                    if (isInitialized) {
                        // Calculate velocity to cover the distance over the 4000ms polling window
                        velocity.lat = (data.lat - currentPos.lat) / 4000;
                        velocity.lng = (data.lng - currentPos.lng) / 4000;
                    } else {
                        currentPos = { lat: data.lat, lng: data.lng };
                        isInitialized = true;
                        map.panTo([currentPos.lat, currentPos.lng]);
                    }
                }
            } catch (err) { console.error("Telemetry Interrupted"); }
        }

        let lastFrameTime = performance.now();
        function animateFlight(now) {
            const deltaTime = now - lastFrameTime;
            lastFrameTime = now;

            if (isInitialized) {
                currentPos.lat += velocity.lat * deltaTime;
                currentPos.lng += velocity.lng * deltaTime;

                // Longitude Wrapping
                if (currentPos.lng > 180) currentPos.lng -= 360;
                if (currentPos.lng < -180) currentPos.lng += 360;

                marker.setLatLng([currentPos.lat, currentPos.lng]);
                map.panTo([currentPos.lat, currentPos.lng], { animate: false });
            }
            requestAnimationFrame(animateFlight);
        }

        updateTelemetry();
        setInterval(updateTelemetry, 4000); 
        requestAnimationFrame(animateFlight);
    </script>
</body>
</html>